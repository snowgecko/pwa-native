<!DOCTYPE html>
<base href=".">
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width minimum-scale=1.0 maximum-scale=1.0 user-scalable=no" />
		<title>Content Pages</title>
		<link rel="shortcut icon" type="image/jpg" href="./favicon.ico"/>

		<link type="text/css" rel="stylesheet" href="./css/style.css" />
		<link type="text/css" rel="stylesheet" href="./css/pages.css" />
		<link type="text/css" rel="stylesheet" href="./css/menu.css" />
		
		<link rel="manifest" href="./manifest.json">
		<!--class declaration--> 
  		<script src="./js/cPage.js" ></script>
  		<script src="./js/cMenu.js" ></script>
		<!--include module for editor--> 
		<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
		<script type="text/javascript" src="./simpleIDB/SimpleIDB.js"></script>
		<script src="./js/tinymce/tinymce.min.js"></script>
		
<script>
	//get url param id and use to pass to lamda service to call content from mongodb
	var url = window.location;
	var urlParams = new URLSearchParams(url.search);
	url_id = urlParams.get('id');
	if ((url_id == "")||(url_id == null)){
		url_id = "1";	
	}
	/*
  	plugins: 'link',
  	menubar: 'insert',
  	toolbar: 'link'
	*/
	//plugins: 'lists',
  	//toolbar: 'numlist bullist'
////finished loading menu	
	window.onload = function() {
		try {
			getMenu(url_id);			
		}catch{
			getMenu(1)
		}
		tinyMCE.init({
			selector: '.editor-content',
				plugins: 'table code lists fullscreen link image',
			  	toolbar: 'undo redo | formatselect | bold italic | numlist bullist | link | image' +
			'alignleft aligncenter alignright alignjustify | indent outdent | ' +
			'table tabledelete | tableprops tablerowprops tablecellprops | tableinsertrowbefore tableinsertrowafter tabledeleterow | tableinsertcolbefore tableinsertcolafter tabledeletecol'
		});
		//hide loading gif...
		//document.getElementById("loader").style.display = "none";	
		document.getElementById("loading_text").style.display = "none";	
		document.getElementById("loader").style.display = "none";	
	};
	
</script>

	</head>
	<body>
		<div id="page">
			<div class="header" id="header">
				<!--//-->
				<div class="text"><a href="#menu" class="menulines"><span></span></a><div id="section_title">Stack Title</div></div>
				<!--//-->
				<div id="mySidenav" class="sidenav">
					<input type="search" name="searchbox" id="searchbox"/>
					<div id="menu">
				      <!--<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>-->
				      	<ul> 
							<li class="Selected"><a href="./">Home</a></li>
							<!--onclick="javascript:toggleMenu(1)"-->
							<div id="html_menu">
								<!--*****WILL BE POPULATED DYNAMICALLY JS******-->
							</div>
							<li><a href="#">About</a></li>
				      		<li><a href="#">Contact</a></li>
						</ul>
					</div>
				</div>
			</div>
			<div class="content main" id="content_main">
				<!--<h3>Title</h3>--><div id="loading_text">loading ....</div><div class="lds-hourglass" id="loader"></div>
				<p id="content">
				<!--START OF EDIT-->
				<!--method="post" action="http://localhost:8086/uploadform"-->
					<form name="form1" id="form1"  class="form_addcontent">
					<!--NEED TO ADD ID, NAME, PARENTID--><!--GET GREATEST NO FROM DATABASE AND ADD 1-->
					<!-- IF I TAKE THE ID OF CURRENT and any page added would be child page-->
					  ID <input type="text"  id="editable_id" class="small">
					  SID<input type="text"  id="editable_sectionid" class="small hidden">
					  ParentID <input type="text"  id="editable_parentid" class="small">
					  PageID <input type="text"  id="editable_pageid" class="small">
					  Page Name: <input type="text"  id="editable_name" class="med">
					<input type="button" value="Add SubPage" onClick="addSubPgae()" class="alignright">
					<br/>
						<strong>Content:</strong>
						<textarea id="editable_content" name="editable_content" class="editor-content wide">
					    </textarea>
						<div id="questions"></div>
						<input type="button" onclick="addQuestion(false)" value="Add question"></input>
						<hr/>
						<p></p>
						<!--<input type="button" value="Download JSON file" onClick="download()" class="alignright">-->
						<input id="postSubmit" type="submit" value="Save Page" class="alignright">
						<!--<button class="file-button" onclick="handleSubmit(event)">Save As</button>-->
					</form>
					</p>
					<div id="storageA"></div>
					</fieldset>
					<!-- FINISHED ADDING--> 
				<!--END OF EDIT-->
				<p>&nbsp;</p>
				<p>&nbsp;</p>
				<p>&nbsp;</p>
			</div>
		</div>
<!--DOES NOT WORK FOR SUB_SUB NAVIGATION ?ARIA issue-->
<script src="./js/cMenu-page.js"></script>		
<!--changed the params when  menuItem_click(evt) is run -->
<!--CLASS SETTINGS-->

<script>	
//********************GET CONTENT on initial page load************************///////
//as called from event Click - getContent(_pageid, parElem.id, _parentid, _sectionid)

//TODO push into offline indexeddb
//need to call lamda and mongo to get menu content based on param id. 
function getMenu(_menuid){
	//instatiate menu class  
	let menu = new Menu(_menuid);  	

	//passing through -1 gets the entire menu json file
	fetch("https://sm5a54kkhi.execute-api.eu-west-1.amazonaws.com/default/listPages?id=-1")
		.then(response => response.json()) //NEW condensed
		.then(data => {
			menu.filter_populateMenu(data, _menuid) //prints out menu of section we are in --> see cMenu.js
			//console.log("in getMenu then statement=" + _url_id)
			//console.log ("_url_id" + _url_id);
			//console.log ("menu.pageid" + menu.pageid);
			getContent(menu.pageid, _menuid, menu.parentid, menu.sectionid);
			//primary_nav.sectionid
		})
}	
//called from getMenu as data needed from menu.json to populate page. 
//call listPages - ie --> return data from ListPages lamda from Pages data. 
function getContent(_pageid, _menuid, _parentid, _sectionid){
	//instatiate page class  
	//console.log("IN getContent()=" + _pageid)
	let page = new Page(_pageid);  	
		
	//console.log("in getContent after new Page() _url_id=" + _url_id)
	//console.log ("_pageid" + _pageid);
	fetch("https://sm5a54kkhi.execute-api.eu-west-1.amazonaws.com/default/listPages?content_id=" + _pageid + "")
		  .then((response) => response.json())
		  .then((pagedata) => {
				//page.pageContent(data, _pageid, _sectionid);
				//console.log("in getContent after then statement _url_id=" + _url_id)
				//console.log("pagedata[0]=" + pagedata[0]);
				page.pageContentEdit(pagedata, _pageid, _menuid, _parentid, _sectionid);
				//pageContent(_pageid, _sectionid)
			})
		  .catch((err) => {
		  	console.log("custom err=" + err);
		     //Do something for an error here
		  })
	//I guess more of a push than a pull 
	//so once this is done it pushes (callsback)
}

//********************SAVE CONTENT - either Page (on form submit) or AddSubPage()************************///////
/* from Download function
	jsonData  += "\"questions\": [";
	jsonData  += writeSubArray();
	jsonData  +=  	"]}]"
*/
const thisForm = document.getElementById("form1");
thisForm.addEventListener('submit', async function (e) {
	//alert("form submitted");
   	e.preventDefault();	
	//posted id to addPage is menuid - as addpage adds record to Menu and Pages data
	var jsonData = JSON.stringify({ 
		id: document.getElementById("editable_id").value, 
		parentid: document.getElementById("editable_parentid").value, 
		pageid: document.getElementById("editable_pageid").value, 
		"pagename": document.getElementById("editable_name").value, 
		"content": tinyMCE.get('editable_content').getContent(), 
		"questions" : "[" + writeSubArray() + "]"
		})
		console.log ("jsonData" + jsonData);
    	let response = await 
			fetch('https://bbx8g5lf6a.execute-api.eu-west-1.amazonaws.com/default/addpage', {
    	   		method: 'POST',
    	   		body: jsonData
    	});
   	 	let result = await response.json();
    	let parsedData = JSON.parse(result.body);
	console.log(parsedData.id)
	console.log(parsedData.pageid)
	alert("Saved Page");
	//const parser = new URL(url || window.location);
	//parser.searchParams.set("id", parsedData.id);
	//window.location = parser.href;
	/* already set above 
	var url = window.location;
	var urlParams = new URLSearchParams(url.search);
	url_id = urlParams.get('id');
	if (url_id != parsedData.id){
		//const url = new URL(window.location);
		//url.searchParams.set('id', parsedData.id);
		//window.history.pushState({}, '', url);			
		//window.location.href = url;	
	}
	*/
	//""{\"lastErrorObject\":{\"n\":1,\"updatedExisting\":false,\"upserted\":\"627114e132b7365bcc4fbb9c\"},\"value\":null,\"ok\":1,\"$clusterTime\":{\"clusterTime\":{\"$timestamp\":\"7093473844685439028\"},\"signature\":{\"hash\":\"mO8lHoTMVye5DPUjubZvusuuR90=\",\"keyId\":{\"low\":16,\"high\":1636813032,\"unsigned\":false}}},\"operationTime\":{\"$timestamp\":\"7093473844685439028\"}}""
	//""{\"lastErrorObject\":{\"n\":1,\"updatedExisting\":true},\"value\":{\"_id\":\"6270fca0504b97b8be4d0457\",\"id\":4,\"pageid\":4,\"parentid\":0,\"pagename\":\"Thames valley critical care course\"},\"ok\":1,\"$clusterTime\":{\"clusterTime\":{\"$timestamp\":\"7093468703609585712\"},\"signature\":{\"hash\":\"+1hyZkQ9OtzmoQTfBd8q93g7BLQ=\",\"keyId\":{\"low\":16,\"high\":1636813032,\"unsigned\":false}}},\"operationTime\":{\"$timestamp\":\"7093468703609585712\"}}{\"acknowledged\":true,\"modifiedCount\":0,\"upsertedId\":null,\"upsertedCount\":0,\"matchedCount\":1}""
	//""{\"lastErrorObject\":{\"n\":1,\"updatedExisting\":false,\"upserted\":\"627116ab32b7365bcc525d60\"},\"value\":null,\"ok\":1,\"$clusterTime\":{\"clusterTime\":{\"$timestamp\":\"7093475811780460563\"},\"signature\":{\"hash\":\"9ia98AeqSXEZUxf3jja2cueYWHg=\",\"keyId\":{\"low\":16,\"high\":1636813032,\"unsigned\":false}}},\"operationTime\":{\"$timestamp\":\"7093475811780460563\"}}{\"acknowledged\":true,\"modifiedCount\":0,\"upsertedId\":\"627116ab32b7365bcc525db5\",\"upsertedCount\":1,\"matchedCount\":0}""
	
	//	var a = document.createElement("a");
	//	a.href = URL.createObjectURL(new Blob([result.body], { type: "text/plain" }));
	//    a.download =  "data" + document.getElementById("editable_pageid").value + ".json";
	//    a.click();
});

/*
[{"_id":"62671229494b8a8d29895518","id":"21","content":"<p></p>","name":"","questions":"[{\"question\":\"Question 1 title \", \"contents\":\"<p>Question 1 content</p>\"}]"}]
*/
//pass -1 through to the lamda function where it allocates an updated id. 
function addSubPgae(){
	var _menuid = "-1";
	var _parentid = document.getElementById("editable_id").value;
	var _sectionid =  document.getElementById("editable_sectionid").value;
	//create new blank (effectively) page object
	let page = new Page("-1");  		

	//jsonData2 = JSON.stringify('[{"_id":"62671229494b8a8d29895518","id":"-1","content":"<p></p>","name":"","questions":"[{\"question\":\"Question 1 title \", \"contents\":\"<p>Question 1 content</p>\"}]"}]')
	const jsonData = '[{"id": "-1", "name": "", "content": "testing", "questions": "[]"}]';
	const obj = JSON.parse(jsonData);
	console.log(obj.content);
		//page.pageContentEdit(pagedata, _pageid, _menuid, _parentid, _sectionid);
		page.pageContentEdit(obj, "-1", "-1", _parentid, _sectionid);
		

	//fetch('https://bbx8g5lf6a.execute-api.eu-west-1.amazonaws.com/default/addpage', { method: 'POST', body: jsonData })
  	//	.then(response => response.json())
  	//	.then(data => console.log(data));

	//console.log ("jsonData" + jsonData);
    //let response = await 
	//fetch('https://bbx8g5lf6a.execute-api.eu-west-1.amazonaws.com/default/addpage', { method: 'POST', body: jsonData });
    //let result = await response.json();
}

function download() {
	//content, fileName
	//const jsonData = { age: 12, name: "Someone" };
	//"id": 9, "name": "Physiology", "content": "", "question1":
	//var page_questions = document.getElementById('questions');
	//console.log("page_questions" + page_questions);
	//var nameValue = document.getElementById("uniqueID").value;	
	
	//.replace(/(&nbsp;)*/g, "")).replace(/(<p>)*/g, "")).replace(/<(\/)?p[^>]*>/g, "");
	jsonData   = 	"[{" 
	jsonData  +=  	JSON.stringify("id") + ":" + JSON.stringify(document.getElementById("editable_id").value) + ","
	jsonData  +=  	JSON.stringify("parentid") + ":" + JSON.stringify(document.getElementById("editable_parentid").value) + ","
	jsonData  +=  	JSON.stringify("pageid") + ":" + JSON.stringify(document.getElementById("editable_pageid").value) + ","
	jsonData  +=  	JSON.stringify("pagename") + ":" + JSON.stringify(document.getElementById("editable_name").value) + ","
	jsonData  +=  	JSON.stringify("content") + ":" + JSON.stringify(tinyMCE.get('editable_content').getContent()) + ","
	jsonData  += "\"questions\": [";
	jsonData  += writeSubArray();
	jsonData  +=  	"]}]";

    var a = document.createElement("a");
	//JSON.stringify(formJSON, null, 2);
    //var file = new Blob(jsonstring, {type: "text/plain"})
	a.href = URL.createObjectURL(new Blob([jsonData], { type: "text/plain" }));
    a.download =  "data" + document.getElementById("editable_pageid").value + ".json";
    a.click();
}


function handleSubmit(event) {
	event.preventDefault();
	var parElem = event.target.parentElement;
	 const data = new FormData(parElem);
	console.log(tinyMCE.get('editable_content').getContent());
	const value = Object.fromEntries(data.entries());
	// const value = data.get('editable_id');
  	console.log({ value });
}
/*{
  "id": 9922,
  "parentid": 0,
  "pageid": 9922,
  "pagename": "new test", 
  "content" : "content for the pages collection/table"
}*/
//download(jsonData, 'json.txt', 'text/plain');
	


//********************FUNCTIONS************************///////
/*This function is called from each Menu click*/
/** called from cMenu-page.js***/
function updatePage(_pageid, _id, _parentid, _sectionid){
	let page1 = new Page(_pageid);
	let result2 = url.toString().includes("pages-edit");
	if (result2){
		page1.pageContentEdit(_pageid, _id, _parentid,  _sectionid);								
	}else{
		page1.pageContent(_pageid, _sectionid);					
	}		
}
/*
<div>  	
	Question: <input type="text"  id="editable_question4" class="wide">
	<textarea id="editable_answer4" name="editable_answer4" class="editor-content wide"></textarea>
</div>
*/
/*add Questions dynamically*/
/*add Question div?*/
//adds blank question //need to combine to add blank content OR populated content 
function addQuestion(_bwithContent){
	//var elem = document.getElementById('container');
	var page_questions = document.getElementById('questions');
	var questions_count = page_questions.childNodes.length;

	updated_number = questions_count;
	console.log("updated_number="+ updated_number);
	 
	var text_string = "Expandable text " + updated_number;
	var question_string = "editable_question" +  updated_number.toString();
	var answer_string = "editable_answer" +  updated_number.toString();

	const text_elem = document.createTextNode(text_string);
	const input_elem = document.createElement("input");
	input_elem.setAttribute('id', question_string);
	input_elem.setAttribute('type', "text");
	input_elem.setAttribute('class', "med");
		
	const textarea_elem = document.createElement("textarea");
	textarea_elem.setAttribute('id', answer_string);
	textarea_elem.setAttribute('name', answer_string);
	textarea_elem.setAttribute('class', "editor-content wide");

	const div_elem = document.createElement("div");
	div_elem.appendChild(text_elem);
	div_elem.appendChild(input_elem);
	div_elem.appendChild(textarea_elem);
	page_questions.appendChild(div_elem);

	console.log(_bwithContent);		
	//called from AddPage click when _bwithContent = false //called from cPage - pageContentEdit with _bwithContent == true
	if (_bwithContent == false){

	    tinymce.init({
	    	selector: '.editor-content',
			plugins: 'table code lists fullscreen',
	  		toolbar: 'undo redo | formatselect | bold italic | ' +
	    	'alignleft aligncenter alignright alignjustify | indent outdent | ' +
			'table tabledelete | tableprops tablerowprops tablecellprops | tableinsertrowbefore tableinsertrowafter tabledeleterow | tableinsertcolbefore tableinsertcolafter tabledeletecol'    });
	}
	//tinyMCE.execCommand("mceAddControl", false, textarea_elem.id)
	//page_questions.append("Question5: <input type=\"text\"  id=\"editable_question5\" class=\"wide\">");
	//page_questions.append("<textarea id=\"editable_answer1\" name=\"editable_answer5\" class=\"editor-content wide\"></textarea>");

}	

function expand_collapse(evt){
	//var coll = document.getElementsByClassName("collapsible");
	//var i;
	//for (i = 0; i < coll.length; i++) {
	//  coll[i].addEventListener("click", function() {
	//var parElem = evt.target.parentElement;
	//alert(evt.target);
	var event_Button = evt.target;
	event_Button.classList.toggle("active");
//event_Button.style.backgroundColor = "red"; //only updates on click
	var content = event_Button.nextElementSibling;
	if (content.style.maxHeight){
		content.style.maxHeight = null;
	} else {
		content.style.maxHeight = content.scrollHeight + "px";
	} 
	//});
//}
}

	//primary_nav.menuID(url_id);
	//primary_nav.setColor();
	//not filled as async .......
	//console.log(primary_nav.menuArray);
	//not filled as async .......
	//class declaration for Page
	//page1 is an instance of Page class

/*
		const div_elem = document.createElement("div");
		div_elem.appendChild(text_elem);
		div_elem.appendChild(input_elem);
		div_elem.appendChild(textarea_elem);
		page_questions.appendChild(div_elem);
*/
//called from jsonData above once submit has been pressed. 
//Need to stop submit from being pressed just for adding editable area. 
function writeSubArray(){
	//var subArray  = "\"questions\": [";
	var subArray = "";
	var subString = ""
	let questions_list = document.getElementById("questions").childNodes;	 //gets back DIVs
	var collection;
	
	//var  array = Array.from(questions_list.childNodes);
	//collection.forEach(function(item){
	//    console.log(item);
	//});
	for (let i = 0; i <= questions_list.length-1; i++) {
		//just brings back the divs
		//console.log(questions_list[i].tagName);
		if ((questions_list[i].children[0].tagName == "INPUT") && (questions_list[i].children[0].value != "")){
			subArray += "{\"question\":"
			subArray +=  JSON.stringify(questions_list[i].children[0].value);
		} 
		if (questions_list[i].children[1].tagName == "TEXTAREA"){
			subArray += ", \"contents\":"
			subArray += JSON.stringify(tinyMCE.get(questions_list[i].children[1].id).getContent()); //returns the node...	
			subArray += "},"
		}
	}	
	subString  +=  subArray.slice(0,-1);
	return subString; 
}


function toggleMenu(p_pageid){
	console.log (p_pageid);
}
//populate();
//OLD VERSION OF FETCH AND RESPONSE - NOW JUST NEED response.json and .then which is async already
async function populate() {
  const requestURL = './assets/testdata.json';
  const request = new Request(requestURL);
  const response = await fetch(request);
  const menuData = await response.json();
  //populateMenu(menuData);

  const requestPageURL = './assets/testpagedata.json';
  const requestPage = new Request(requestPageURL);
  const responsePage = await fetch(requestPage);
  const pageData = await responsePage.json();
  populatePage(pageData);
}

//I do not need to do this with the menu as I can populate it from the indexedDB
//so I just need to call cidb.fill?
function populateMenu(obj) {
	
  	const submenu = document.getElementById('submenu');
	//console.log(obj['pageName']); // eg Physiology - root 
 	menuString = "";
        Object.entries(obj).forEach(([key, value]) => {
			menuString += key + " " ;			 
            console.log(key);
			menuString += value + "<br/>";
            console.log(value);
        });
        console.log('-------------------');
  submenu.textContent = menuString;
  //console.log(menuString);
}
function populatePage(obj){
	const myPara = document.getElementById("content");
	myPara.textContent = `Hometown: ${obj['homeTown']} // Formed: ${obj['formed']}`;
  	//header.appendChild(myPara);

}

</script>

</body>
</html>
