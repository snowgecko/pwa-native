<!DOCTYPE html>
<base href=".">
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width minimum-scale=1.0 maximum-scale=1.0 user-scalable=no" />
		<title>Content Pages</title>
		<link rel="shortcut icon" type="image/jpg" href="./favicon.ico"/>
		<link rel="manifest" href="./manifest.json">
	  	<link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png"/>
		<link rel="apple-touch-icon" sizes="152x152" href="/images/icons/icon-152x152.png"/>
		<link rel="apple-touch-icon" sizes="167x167" href="/images/icons/icon-152x152.png"/>
		<link rel="apple-touch-icon" sizes="180x180" href="/images/icons/icon-192x192.png"/>
	

		<link type="text/css" rel="stylesheet" href="./css/style.css" />
		<link type="text/css" rel="stylesheet" href="./css/pages.css" />
		<link type="text/css" rel="stylesheet" href="./css/menu.css" />		
  		<link rel="stylesheet" type="text/css" href="/css/loader.css"/>
<!--just for the home page-->
		<link rel="stylesheet" href="./css/home.css">
		
		<!--class declaration--> 
  		<script src="./js/cPage.js" ></script>
  		<script src="./js/cMenu.js" ></script>
		<script type="text/javascript" src="./simpleIDB/SimpleIDB.js"></script>
		<!--DOES NOT WORK FOR SUB_SUB NAVIGATION ?ARIA issue-->
		<script src="./js/dl_1.js"></script>	<!--refactoring-->	
		<script src="./js/prl_1.js"></script>	<!--refactoring-->	
		<script src="./js/functions_data.js"></script>		
		<!--include module for editor--> 
		<script src="./js/functions_editor.js"></script>		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
		<script src="./js/tinymce/tinymce.min.js"></script>
		
<script>
window.addEventListener('load', ()=>{
    //console.log("in window load");	
	if ("serviceWorker" in navigator) {
	    try {
      		navigator.serviceWorker.register('./serviceWorker.js');
      		//console.log("Service Worker Registered");
    	} catch (error) {
      		//console.log("Service Worker Registration Failed");
		}
    }else{
	   //console.log("Service Worker not supported?");
	}
});
</script>
</head>
	<body>
	    <header> 
	      <h1><image src="./favicon.ico" alt="picture of stack of papers"/> STACK</h1>
	    </header>
		<div id="page">
			<div class="header" id="header">
				<div class="floatright" id="offline">online</div>
				<label class="switch">
				<input type="checkbox" id="ckslider">
				<span class="slider round" id="slider"></span>
				</label>
				<!--//-->
				<div class="text"><a href="#menu" class="menulines"><span></span></a><div id="section_title">.....</div></div>
				<!--//-->
				<div id="mySidenav" class="sidenav">
					<input type="search" name="searchbox" id="searchbox" onKeyUp="edValueKeyPress()"/>
					<div id="menu">
				      <!--<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>-->
				      	<ul> 
							<!--onclick="javascript:toggleMenu(1)"-->
							<div id="html_menu">
								<!--*****WILL BE POPULATED DYNAMICALLY JS******-->
							</div>
							<li><a href="#">About</a></li>
				      		<li><a href="#">Contact</a></li>
							<li><a href="#" id="logout">logout (exit)</a></li>
						</ul>
					</div>
				</div>
			    <div class="ca_loaders" id="ca_loaders">
			      <div class="ca_loader" id="ca_loader">
			        <div class="loader-inner ball-grid-pulse">
			          <div></div>
			          <div></div>
			          <div></div>
			          <div></div>
			          <div></div>
			          <div></div>
			          <div></div>
			          <div></div>
			          <div></div>
			        </div>
			      </div>
				<p>&nbsp;&nbsp;&nbsp;loading content....</p>
				</div>
			</div>
			<!-- IMPORTANT THINGS TO CHANGE
			headerimage 
			para_loader visible at the start - then changes on load 
			content = 
				login page first if not logged in  
				homepage IF logged and has a choice of sections 
				section page if logged and has one subscription
			-->
			<!-- change header depending on section-->
			<div class="headerimage" id="headerimage"></div>
			<!-- /////-->
			<div class="content main" id="content_main">
				<h3><!--does not appear after load--></h3><div id="para_loader"><p><div id="loading_text">loading ....</div><div class="lds-hourglass" id="loader"></div></p></div>
				<!--content once the indexedDB is loaded-->
				<div id="content_variable">
					<section class="testimonials" id="homepagepads">
						<div class="container">
						  <div class="testimonial grid-6">
							<div class="card">
							  <div class="circle">
								<!--<img src="./images/4.jpg" alt="">-->
							  </div>
							  <h3 class="pad"><a href="index.html?id=1">FRCA Primary</a></h3>
							  <p>Resources and questions relevant to the Primary FRCA exam</p>
							</div>
							<div class="card">
							  <div class="circle">
								<!--<img src="./images/4.jpg" alt="">-->
							</div>
							  <h3 class="pad"><a href="index.html?id=2">FRCA Final</a></h3>
							  <p>Resources and questions relevant to the Final FRCA exam</p>
							</div>
							<div class="card">
							  <div class="circle">
								<!--<img src="./images/4.jpg" alt="">-->
							</div>
							  <h3 class="pad"><a href="index.html?id=4">FICM</a></h3>
							  <p>Resources and questions relevant to the Part 1 FICM exam</p>
							</div>
							<div class="card">
								<div class="circle">
								  <!--<img src="./images/4.jpg" alt="">-->
								</div>
								<h3 class="pad"><a href="index.html?id=4">Thames valley CCC</a></h3>
								<p>Resources and questions relevant Thames valley Critical Care course</p>
							  </div>
							  <div class="card">
								<div class="circle">
								  <!--<img src="./images/4.jpg" alt="">-->
							  </div>
								<h3>Pain</h3>
								<p>Resources and questions relevant to the Pain exams</p>
							  </div>
							  <div class="card">
								<div class="circle">
								  <!--<img src="./images/4.jpg" alt="">-->
							  </div>
								<h3 class="pad"><a href="index.html?id=58">Developement</a></h3>
								<p>... coming soon...</p>
							  </div>
							</div>
						</div>
					  </section>

					<form name="form1" id="form1"  class="form_addcontent">
						<!--NEED TO ADD ID, NAME, PARENTID--><!--GET GREATEST NO FROM DATABASE AND ADD 1-->
						<!-- IF I TAKE THE ID OF CURRENT and any page added would be child page-->
						Page Name: <input type="text"  id="editable_name" class="med"><br/>
						ID <input type="text"  id="editable_id" class="small">
						SID<input type="text"  id="editable_sectionid" class="small">
						ParentID <input type="text"  id="editable_parentid" class="small">
						PageID <input type="text"  id="editable_pageid" class="small">
						PageOrder <input type="text"  id="editable_pageorder" class="small">
						<input type="button" value="Add SubPage" onClick="addSubPgae()" class="alignright">
						<br/>
						<strong>Content:</strong>
						<textarea id="editable_content" name="editable_content" class="editor-content wide">
					    </textarea>
						<div id="questions"></div>
						<input type="button" onclick="addQuestionDivs()" value="Add question"></input>
						<hr/>
						<p></p>
						<!--<input type="button" value="Download JSON file" onClick="download()" class="alignright">-->
						<input id="postSubmit" type="submit" value="Save Page" class="alignright">
						<!--<button class="file-button" onclick="handleSubmit(event)">Save As</button>-->
					</p>
					<div id="storageA"></div>
					</fieldset>
					</form>
					<!-- FINISHED ADDING--> 
					<!--END OF EDIT-->
					<div id="message"></div>
				</div>
			</div>
			<!-- /////-->
			<div id="login_main">			
				<!--LOGIN START used on login page-->
					<form method="post" id="loginForm">
						<h3>Login</h3>
		          		<label for="username">Email &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
		          		<input type="text" id="username" name="username" required><br/>
		          		<label for="password">Password&nbsp;&nbsp;</label>
		          		<input type="text" id="password" name="password" required><br/>&nbsp;<br/>
	          			<button type="submit" id="submitBtn">Login</button>
					</form>
					<p id="passwordmessage"></p>
					<!--//-->
					<!--LOGIN END used on login page-->
				<!--<p><a href="#" id="logout">logout (exit)</a></p>-->
			</div>
		</div>
<script>
	//*****global variables set in functions_shared.js
	var cidb = new SimpleIDB();
	var bIsLoggedIn = new Boolean(false);
	var gMenuDataSource = getRemoteMenuData;
	var gPageDataSource = getRemotePageData;
	var listElem; 
	var bEditMode = true;
	
	const homepageNode = document.getElementById("homepagepads");
	const loginNode = document.getElementById("loginForm");
	const contentVar_div = document.getElementById("content_variable");
	const pagecontent_div = document.getElementById("page_content");
	const message_div = document.getElementById("message");

	const para_loader = document.getElementById("para_loader");
	const ca_loaders = document.getElementById("ca_loaders");
	const contentItems = document.querySelectorAll(".content");

	const formNode = document.getElementById("form1");
		
	window.onload = function() {
				
		verifyUserContent(cidb, gMenuDataSource);
		//set defaults 		
		formNode.style.display = "none";
		homepageNode.style.display = "none";		
		loginNode.style.display = "block";
		
		contentItems.forEach(function(cItems) {
			addEvent(cItems);
		});				
		document.querySelector( 'a[href="#menu"]' )
			.addEventListener( 'click', e => {
				e.preventDefault();
				changeNavState(); //called from functions_shared.js - simply changes classes
		});
		document.body.addEventListener("click", function(e) {
			e.preventDefault();
			if(e.target.id == "submitBtn"){
				var username = document.getElementById("username").value;
				var password = document.getElementById("password").value;
				///************************VERIFYLOGIN - needs to be called from LoginForm AND onload**************
				const output = verifyLogin(cidb, gMenuDataSource, username, password);
			}else if(e.target && e.target.id == "logout") {
				UserLoggedOut();					
				changeNavState();
			}else if(e.target && e.target.nodeName == "A") {
				var loc_href = e.target.href 
				var equalsLoc = loc_href.indexOf("?id=") + 4; //? + 3
				var eTargetID = loc_href.substring(equalsLoc, loc_href.length);
				history.pushState('data to be passed', 'Page Title', loc_href );
				if(e.target.parentNode.className.indexOf("pad")!=-1){
					const menuData = gMenuDataSource(cidb, eTargetID, eTargetID); //var x = await **calls different function based on edit or NOT edit */ 							
				}
				if (loc_href.indexOf("#menu") == -1){
					resolveLink_ExpandMenu_printPage(e);	
				} 
			}else{
				//console.log ("on click with no event listener attached");
			}
		});
			 
		/* example dialog that inserts the name of a Pet into the editor content */
		const dialogConfig =  {
		title: 'Pet Name Machine',
		body: {
			type: 'panel',
			items: [
			{
				type: 'input',
				name: 'casedata',
				label: 'Enter Case'
			},
			{
				type: 'input',
				name: 'question1data',
				label: 'Enter Question'
			},
			{
				type: 'input',
				name: 'answer1data',
				label: 'Enter Answer'
			},
			{
				type: 'input',
				name: 'question2data',
				label: 'Enter Question'
			},
			{
				type: 'input',
				name: 'answer2data',
				label: 'Enter Answer'
			},
			]
		},
		buttons: [
			{
			type: 'cancel',
			name: 'closeButton',
			text: 'Cancel'
			},
			{
			type: 'submit',
			name: 'submitButton',
			text: 'Submit',
			buttonType: 'primary'
			}
		],
		initialData: {
			casedata: 'Case title'
		},
		onSubmit: (api) => {
			const data = api.getData();
			//const pet = data.isdog ? 'dog' : 'cat';
			const caseText = `<div class="ac"><input class="ac-input" id="ac-1" name="ac-1" type="checkbox" /><label class="ac-label" for="ac-1">Case 1</label>`;
			const startArticlesText = `<article class="ac-text">`;
			const question1Text = `<div class="ac-sub"><input class="ac-input" id="ac-2" name="ac-2" type="checkbox" /><label class="ac-label" for="ac-2">${data.question1data}</label>`;
			const answer1Text = `<article class="ac-sub-text"><p>${data.answer1data}</p></article></div>`
			const endArticlesText = `</article>`;
			const caseEndText = `</div>`;
			const fullText = caseText + startArticlesText + question1Text + answer1Text + endArticlesText + caseEndText

			tinymce.activeEditor.execCommand('mceInsertContent', false, fullText);
			api.close();
		}
		};


		tinymce.init({
			selector: '.editor-content',
			content_css: '../css/pages.css',
			init_instance_callback: function (editor) {
				// Shortcuts and useful things go here.
				editor.shortcuts.add("alt+s", "Save Me My Content", function() {
					savePage();		    				
					//alert("saved");
  				}),
	    		editor.shortcuts.add("alt+b", "A New Way To Bold", "Bold");
  			},
			setup: function (editor) {
				editor.ui.registry.addButton('InsertAccordian', {
      				icon: 'code-sample',
      				onAction: () => editor.windowManager.open(dialogConfig)
    			});
				editor.ui.registry.addButton('AnswerDiv', {
				  text: 'Add Question',
				  onAction: function (_) {
					editor.insertContent('<blockquote><p>Question:&nbsp;&nbsp;</p><div class="answer"><p>Answer:&nbsp;</p></div></blockquote><p>&nbsp;</p>');
					//editor.dom.setOuterHTML(editor.selection.getNode(),'<div class="answer">'+editor.dom.getOuterHTML(editor.selection.getNode())+'</div>'); 

				  }
			   });				
			},
			plugins: 'table code lists fullscreen link image',
			toolbar: 'AnswerDiv InsertAccordian undo redo | formatselect | bold italic | numlist bullist | link | image' +
			'alignleft aligncenter alignright alignjustify | indent outdent | ' +
			'table tabledelete | tableprops tablerowprops tablecellprops | tableinsertrowbefore tableinsertrowafter tabledeleterow | tableinsertcolbefore tableinsertcolafter tabledeletecol',
		 	/* enable title field in the Image dialog*/
		 	image_title: true,
			automatic_uploads: true,
			file_picker_types: 'image',
			file_picker_callback: function (cb, value, meta) {
				var input = document.createElement('input');
				input.setAttribute('type', 'file');
				input.setAttribute('accept', 'image/*');
				input.onchange = function () {
					  var file = this.files[0];
					  var reader = new FileReader();
					  reader.onload = function () {
					/*
					  Note: Now we need to register the blob in TinyMCEs image blob
					  registry. In the next release this part hopefully won't be
					  necessary, as we are looking to handle it internally.
					*/
					var id = 'blobid' + (new Date()).getTime();
					var blobCache =  tinymce.activeEditor.editorUpload.blobCache;
					var base64 = reader.result.split(',')[1];
					var blobInfo = blobCache.create(id, file, base64);
					blobCache.add(blobInfo);
					/* call the callback and populate the Title field with the file name */
					cb(blobInfo.blobUri(), { title: file.name });
				  };
			  reader.readAsDataURL(file);
			};
			input.click();
	  		}
		});	
		//document.body.addEventListener
		//document.getElementById("searchbox").addEventListener("keypress", edValueKeyPress);
		
		/*******event listeners*****/
	};	

</script>

</body>
</html>
